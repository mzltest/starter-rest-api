<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>九宫格图片验证码</title>
  <style>
    .container {
      display: flex;
      flex-wrap: wrap;
      max-width: 600px;
      margin: 0 auto;
    }

    .image {
      position: relative;
      width: calc(33.33% - 10px);
      margin: 5px;
      cursor: pointer;
    }

    .image img {
      width: 100%;
      height: auto;
    }

    .image.selected::after {
      content: '\2713';
      position: absolute;
      top: 100px;
      right: 100px;
      color: white;
      font-size: 24px;
      background-color: rgba(30, 200, 50, 0.7);
      padding: 4px;
      border-radius: 50%;
    }
  </style>
</head>
<body>
  <div class="container"></div>
  <input type="text" id="selectedImages" readonly>
  <button onclick="submit()">提交</button>

  <script>
    var chalId=''//challengeID
    function createImageElement(base64, id) {
      var container = document.querySelector('.container');
      container.innerHTML=''
      var imageContainer = document.createElement('div');
      imageContainer.className = 'image';

      var image = document.createElement('img');
      image.src = 'data:image/jpeg;base64,' + base64;

      image.addEventListener('click', function() {
        if (imageContainer.classList.contains('selected')) {
          imageContainer.classList.remove('selected');
          removeImageId(id);
        } else {
          imageContainer.classList.add('selected');
          addImageId(id);
        }
      });

      imageContainer.appendChild(image);
      container.appendChild(imageContainer);
    }

    function addImageId(id) {
      var selectedImagesInput = document.getElementById('selectedImages');
      var currentValue = selectedImagesInput.value.trim();
      if (currentValue === '') {
        selectedImagesInput.value = id;
      } else {
        selectedImagesInput.value = currentValue + '|' + id;
      }
    }

    function removeImageId(id) {
      var selectedImagesInput = document.getElementById('selectedImages');
      var currentValue = selectedImagesInput.value.trim();
      var ids = currentValue.split('|');
      var updatedIds = ids.filter(function(item) {
        return item !== id;
      });
      selectedImagesInput.value = updatedIds.join('|');
    }

    function getchal(){
      document.querySelector('.container').innerHTML='<h1>正载入挑战...</h1>'
    // 发起请求获取图片数据
    fetch('/api/create')
      .then(function(response) {
        return response.json();
      })
      .then(function(data) {
        if (data.ok && data.data ) {
          chalId=data.id
          data.data.forEach(function(item) {
            createImageElement(item.base64, item.id);
          });
        }
      })
      .catch(function(error) {
        console.log('Error:', error);
      })
    }
      function submit(){
        fetch(`/api/verify/${encodeURIComponent(chalId)}/${encodeURIComponent(document.getElementById('selectedImages').value)}`)
      .then(function(response) {
        return response.json();
      })
      .then(function(data) {
        if (data.ok && data.data ) {
  alert(data.data)
        }
        else{
          alert(data.err)
          if(data.reload==true){
            getchal()
          }
        }
      })
      .catch(function(error) {
        console.log('Error:', error);
      });
      }

      getchal()
  </script>
</body>
</html>
